<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Subscription Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
            padding: 16px;
            padding-bottom: 100px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 24px;
            padding-top: 10px;
        }

        h1 {
            font-size: 1.8rem;
            background: linear-gradient(90deg, #e94560, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 6px;
        }

        .subtitle {
            color: #8892b0;
            font-size: 0.9rem;
        }

        /* Stats Cards - Horizontal Scroll on Mobile */
        .stats-scroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 0 -16px 24px -16px;
            padding: 0 16px;
            scrollbar-width: none;
        }

        .stats-scroll::-webkit-scrollbar {
            display: none;
        }

        .stats-grid {
            display: flex;
            gap: 12px;
            min-width: max-content;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 16px 20px;
            min-width: 140px;
            flex-shrink: 0;
        }

        .stat-card h3 {
            color: #8892b0;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .stat-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #e94560;
        }

        .stat-card .change {
            font-size: 0.7rem;
            color: #64ffda;
            margin-top: 4px;
        }

        .stat-card.savings .value {
            color: #64ffda;
        }

        /* Budget Section */
        .budget-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .budget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .budget-header h2 {
            color: #ccd6f6;
            font-size: 1rem;
        }

        .budget-edit {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #8892b0;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
        }

        .progress-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            height: 28px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
            background: linear-gradient(90deg, #64ffda, #4facfe);
        }

        .progress-bar.over-budget {
            background: linear-gradient(90deg, #e94560, #ff6b6b);
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 600;
            font-size: 0.85rem;
            color: #1a1a2e;
        }

        .budget-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.75rem;
            color: #8892b0;
        }

        /* Charts - Stack on Mobile */
        .charts-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 16px;
        }

        .chart-container h2 {
            margin-bottom: 12px;
            font-size: 1rem;
            color: #ccd6f6;
        }

        /* To Cancel Section */
        .to-cancel-section {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .to-cancel-section h2 {
            color: #ffc107;
            margin-bottom: 12px;
            font-size: 1rem;
        }

        .to-cancel-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .to-cancel-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .to-cancel-item .price {
            color: #ffc107;
            font-weight: 600;
        }

        .savings-row {
            display: flex;
            gap: 20px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 193, 7, 0.2);
        }

        .savings-stat .label {
            color: #8892b0;
            font-size: 0.7rem;
        }

        .savings-stat .value {
            color: #64ffda;
            font-size: 1.2rem;
            font-weight: 700;
        }

        /* Subscriptions Section */
        .subscriptions-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .section-header {
            margin-bottom: 16px;
        }

        .section-header h2 {
            font-size: 1rem;
            color: #ccd6f6;
            margin-bottom: 12px;
        }

        /* Filter Pills - Horizontal Scroll */
        .filter-scroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 0 -16px;
            padding: 0 16px;
            scrollbar-width: none;
        }

        .filter-scroll::-webkit-scrollbar {
            display: none;
        }

        .filter-tabs {
            display: flex;
            gap: 8px;
            min-width: max-content;
        }

        .filter-tab {
            padding: 10px 16px;
            border-radius: 20px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #8892b0;
            font-size: 0.85rem;
            white-space: nowrap;
            cursor: pointer;
        }

        .filter-tab.active {
            background: #e94560;
            color: #fff;
        }

        /* Search Bar */
        .search-bar {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            margin-bottom: 16px;
        }

        .search-input {
            flex: 1;
            padding: 12px 16px;
            border-radius: 12px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1rem;
        }

        .search-input::placeholder {
            color: #8892b0;
        }

        .sort-btn {
            padding: 12px 16px;
            border-radius: 12px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #8892b0;
            font-size: 1.1rem;
        }

        /* Subscription Cards - Mobile Optimized */
        .subscription-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .subscription-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .subscription-item.to-cancel {
            border-color: rgba(255, 193, 7, 0.5);
            background: rgba(255, 193, 7, 0.1);
        }

        .sub-main {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .sub-icon {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            flex-shrink: 0;
        }

        .sub-info {
            flex: 1;
            min-width: 0;
        }

        .sub-info h4 {
            font-size: 1rem;
            color: #fff;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sub-info span {
            font-size: 0.8rem;
            color: #8892b0;
        }

        .sub-info .due-soon {
            color: #ffc107;
        }

        .sub-price {
            text-align: right;
        }

        .sub-price .amount {
            font-size: 1.3rem;
            font-weight: 700;
            color: #e94560;
        }

        .sub-price .period {
            font-size: 0.7rem;
            color: #8892b0;
        }

        .sub-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .rating {
            display: flex;
            gap: 4px;
        }

        .rating span {
            font-size: 1.3rem;
            opacity: 0.3;
            cursor: pointer;
            padding: 4px;
        }

        .rating span.active {
            opacity: 1;
        }

        .sub-actions {
            display: flex;
            gap: 8px;
        }

        .sub-actions button {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: none;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .btn-edit { background: rgba(79, 172, 254, 0.2); color: #4facfe; }
        .btn-cancel { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
        .btn-delete { background: rgba(233, 69, 96, 0.2); color: #e94560; }
        .btn-restore { background: rgba(100, 255, 218, 0.2); color: #64ffda; }

        /* Category Colors */
        .category-ai { background: linear-gradient(135deg, #667eea, #764ba2); }
        .category-creative { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .category-productivity { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .category-google { background: linear-gradient(135deg, #43e97b, #38f9d7); }
        .category-other { background: linear-gradient(135deg, #fa709a, #fee140); }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e94560, #ff6b6b);
            border: none;
            color: white;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(233, 69, 96, 0.5);
            cursor: pointer;
            z-index: 100;
        }

        .fab:active {
            transform: scale(0.95);
        }

        /* Top Action Bar */
        .top-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .top-btn {
            padding: 10px 16px;
            border-radius: 10px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #ccd6f6;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        /* Modal - Full Screen on Mobile */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            padding: 0;
            overflow-y: auto;
        }

        .modal-overlay.active {
            display: block;
        }

        .modal {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            min-height: 100vh;
            padding: 20px;
            padding-top: 60px;
        }

        .modal-close {
            position: fixed;
            top: 16px;
            right: 16px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            font-size: 1.5rem;
            z-index: 1001;
            cursor: pointer;
        }

        .modal h2 {
            color: #ccd6f6;
            margin-bottom: 24px;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #8892b0;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 1rem;
        }

        .form-group select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%238892b0' stroke-width='2'%3E%3Cpolyline points='6,9 12,15 18,9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 44px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .btn-save {
            width: 100%;
            padding: 18px;
            border-radius: 14px;
            border: none;
            background: linear-gradient(135deg, #e94560, #ff6b6b);
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 24px;
            cursor: pointer;
        }

        /* Sort Modal */
        .sort-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1a1a2e;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            transform: translateY(100%);
            transition: transform 0.3s;
            z-index: 1000;
        }

        .sort-modal.active {
            transform: translateY(0);
        }

        .sort-modal h3 {
            color: #ccd6f6;
            margin-bottom: 16px;
            text-align: center;
        }

        .sort-option {
            padding: 16px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 8px;
            color: #ccd6f6;
            text-align: center;
            cursor: pointer;
        }

        .sort-option.active {
            background: rgba(233, 69, 96, 0.2);
            color: #e94560;
        }

        .sort-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .sort-overlay.active {
            display: block;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #64ffda;
            color: #1a1a2e;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            opacity: 0;
            transition: all 0.3s;
            z-index: 2000;
            white-space: nowrap;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #8892b0;
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 20px;
            color: #8892b0;
            font-size: 0.8rem;
        }

        /* Desktop Enhancements */
        @media (min-width: 768px) {
            body {
                padding: 24px;
            }

            h1 {
                font-size: 2.2rem;
            }

            .stats-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                min-width: auto;
            }

            .stat-card {
                min-width: auto;
            }

            .charts-section {
                grid-template-columns: 1fr 1fr;
            }

            .modal {
                max-width: 500px;
                margin: 40px auto;
                min-height: auto;
                border-radius: 20px;
                padding: 30px;
                padding-top: 30px;
            }

            .modal-close {
                position: absolute;
                top: 16px;
                right: 16px;
            }

            .fab {
                bottom: 32px;
                right: 32px;
            }

            .subscription-item {
                flex-direction: row;
                align-items: center;
            }

            .sub-bottom {
                border-top: none;
                padding-top: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üí≥ Subscriptions</h1>
            <p class="subtitle">Track & Optimize Your Monthly Spend</p>
        </header>

        <div class="top-actions">
            <button class="top-btn" onclick="exportCSV()">üì• Export</button>
            <button class="top-btn" onclick="editBudget()">üéØ Budget</button>
        </div>

        <div class="stats-scroll">
            <div class="stats-grid" id="statsGrid"></div>
        </div>

        <div class="budget-section">
            <div class="budget-header">
                <h2>üéØ Monthly Budget</h2>
                <button class="budget-edit" onclick="editBudget()">Edit</button>
            </div>
            <div class="progress-container">
                <div class="progress-bar" id="budgetProgress"></div>
                <span class="progress-text" id="budgetText"></span>
            </div>
            <div class="budget-labels">
                <span>$0</span>
                <span id="budgetGoal">$500</span>
            </div>
        </div>

        <div class="to-cancel-section" id="toCancelSection" style="display:none">
            <h2>‚ö†Ô∏è To Cancel</h2>
            <div class="to-cancel-list" id="toCancelList"></div>
            <div class="savings-row">
                <div class="savings-stat">
                    <div class="label">Monthly Savings</div>
                    <div class="value" id="potentialSavings">$0</div>
                </div>
                <div class="savings-stat">
                    <div class="label">Annual Savings</div>
                    <div class="value" id="potentialAnnualSavings">$0</div>
                </div>
            </div>
        </div>

        <div class="charts-section">
            <div class="chart-container">
                <h2>üìä By Category</h2>
                <canvas id="categoryChart"></canvas>
            </div>
            <div class="chart-container">
                <h2>üìà Trend</h2>
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <div class="subscriptions-section">
            <div class="section-header">
                <h2>üîÑ Subscriptions</h2>
                <div class="filter-scroll">
                    <div class="filter-tabs">
                        <button class="filter-tab active" data-filter="all">All</button>
                        <button class="filter-tab" data-filter="ai">AI</button>
                        <button class="filter-tab" data-filter="creative">Creative</button>
                        <button class="filter-tab" data-filter="productivity">Productivity</button>
                        <button class="filter-tab" data-filter="google">Google</button>
                        <button class="filter-tab" data-filter="other">Other</button>
                    </div>
                </div>
            </div>
            
            <div class="search-bar">
                <input type="text" class="search-input" id="searchInput" placeholder="üîç Search...">
                <button class="sort-btn" onclick="openSortModal()">‚áÖ</button>
            </div>

            <div class="subscription-list" id="subscriptionList"></div>
        </div>

        <footer>
            <p>Saved locally ‚Ä¢ <span id="lastUpdated"></span></p>
            <p>Built with ü¶â by Kip</p>
        </footer>
    </div>

    <!-- Floating Add Button -->
    <button class="fab" onclick="openAddModal()">+</button>

    <!-- Add/Edit Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <button class="modal-close" onclick="closeModal()">‚úï</button>
        <div class="modal">
            <h2 id="modalTitle">Add Subscription</h2>
            <form id="subscriptionForm">
                <input type="hidden" id="editId">
                
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="subName" required placeholder="Netflix, Spotify, etc.">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Price/Month</label>
                        <input type="number" id="subPrice" step="0.01" required placeholder="9.99">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="subCategory">
                            <option value="ai">AI Tools</option>
                            <option value="creative">Creative</option>
                            <option value="productivity">Productivity</option>
                            <option value="google">Google/Apple</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Billing Day</label>
                        <input type="number" id="subBillingDay" min="1" max="31" placeholder="15">
                    </div>
                    <div class="form-group">
                        <label>Icon</label>
                        <input type="text" id="subIcon" placeholder="üé¨" maxlength="2">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Notes</label>
                    <input type="text" id="subNote" placeholder="Pro Plan, Team, etc.">
                </div>
                
                <button type="submit" class="btn-save">Save Subscription</button>
            </form>
        </div>
    </div>

    <!-- Budget Modal -->
    <div class="modal-overlay" id="budgetModalOverlay">
        <button class="modal-close" onclick="closeBudgetModal()">‚úï</button>
        <div class="modal">
            <h2>Set Budget</h2>
            <form id="budgetForm">
                <div class="form-group">
                    <label>Monthly Budget ($)</label>
                    <input type="number" id="budgetInput" step="1" required placeholder="500">
                </div>
                <button type="submit" class="btn-save">Save Budget</button>
            </form>
        </div>
    </div>

    <!-- Sort Modal (Bottom Sheet) -->
    <div class="sort-overlay" id="sortOverlay" onclick="closeSortModal()"></div>
    <div class="sort-modal" id="sortModal">
        <h3>Sort By</h3>
        <div class="sort-option" data-sort="name">Name (A-Z)</div>
        <div class="sort-option" data-sort="price-high">Price (High to Low)</div>
        <div class="sort-option" data-sort="price-low">Price (Low to High)</div>
        <div class="sort-option" data-sort="billing">Billing Date</div>
        <div class="sort-option" data-sort="rating">Rating</div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // Default data
        const defaultSubscriptions = [
            { id: 1, name: 'OpenAI ChatGPT', category: 'ai', price: 200, icon: 'ü§ñ', note: 'Pro', billingDay: 12, rating: 5, status: 'active' },
            { id: 2, name: 'Claude.AI', category: 'ai', price: 120, icon: 'üß†', note: 'Max', billingDay: 26, rating: 5, status: 'active' },
            { id: 3, name: 'Perplexity', category: 'ai', price: 10, icon: 'üîç', note: 'Pro', billingDay: 4, rating: 3, status: 'active' },
            { id: 4, name: 'Anthropic API', category: 'ai', price: 5, icon: '‚ö°', note: '', billingDay: 3, rating: 4, status: 'active' },
            { id: 5, name: 'Higgsfield', category: 'creative', price: 80, icon: 'üé¨', note: 'Video', billingDay: 2, rating: 4, status: 'active' },
            { id: 6, name: 'Suno', category: 'creative', price: 10.73, icon: 'üéµ', note: 'Music', billingDay: 7, rating: 4, status: 'active' },
            { id: 7, name: 'Runway', category: 'creative', price: 15, icon: 'üé•', note: '', billingDay: 9, rating: 3, status: 'active' },
            { id: 8, name: 'Notion', category: 'productivity', price: 24, icon: 'üìù', note: 'Team', billingDay: 3, rating: 5, status: 'active' },
            { id: 9, name: 'Canva', category: 'productivity', price: 14.99, icon: 'üé®', note: 'Pro', billingDay: 5, rating: 4, status: 'active' },
            { id: 10, name: 'Loom', category: 'productivity', price: 24, icon: 'üìπ', note: '', billingDay: 6, rating: 2, status: 'active' },
            { id: 11, name: 'Gamma', category: 'productivity', price: 20, icon: 'üìä', note: '', billingDay: 15, rating: 3, status: 'active' },
            { id: 12, name: 'Adobe', category: 'productivity', price: 69.99, icon: 'üÖ∞Ô∏è', note: 'CC', billingDay: 13, rating: 4, status: 'active' },
            { id: 13, name: 'Obsidian', category: 'productivity', price: 5, icon: 'üíé', note: 'Sync', billingDay: 8, rating: 4, status: 'active' },
            { id: 14, name: 'Mem AI', category: 'productivity', price: 12, icon: 'üß©', note: '', billingDay: 14, rating: 2, status: 'active' },
            { id: 15, name: 'Google', category: 'google', price: 67, icon: 'üîµ', note: 'Workspace', billingDay: 1, rating: 5, status: 'active' },
            { id: 16, name: 'Apple', category: 'google', price: 35, icon: 'üçé', note: 'Services', billingDay: 22, rating: 4, status: 'active' },
            { id: 17, name: 'Takeover', category: 'other', price: 7, icon: 'üì∫', note: '', billingDay: 1, rating: 3, status: 'active' },
        ];

        let subscriptions = [];
        let budget = 500;
        let currentFilter = 'all';
        let currentSort = 'name';
        let categoryChart = null;
        let trendChart = null;

        function loadData() {
            const saved = localStorage.getItem('subscriptions_v2');
            const savedBudget = localStorage.getItem('budget_v2');
            subscriptions = saved ? JSON.parse(saved) : [...defaultSubscriptions];
            budget = savedBudget ? parseFloat(savedBudget) : 500;
            if (!saved) saveData();
        }

        function saveData() {
            localStorage.setItem('subscriptions_v2', JSON.stringify(subscriptions));
            localStorage.setItem('budget_v2', budget.toString());
            document.getElementById('lastUpdated').textContent = new Date().toLocaleDateString();
        }

        function getStats() {
            const active = subscriptions.filter(s => s.status === 'active');
            const toCancel = subscriptions.filter(s => s.status === 'to-cancel');
            const cancelled = subscriptions.filter(s => s.status === 'cancelled');
            const monthlyTotal = active.reduce((sum, s) => sum + s.price, 0);
            return {
                monthlyTotal,
                annualTotal: monthlyTotal * 12,
                activeCount: active.length,
                toCancelTotal: toCancel.reduce((sum, s) => sum + s.price, 0),
                cancelledTotal: cancelled.reduce((sum, s) => sum + s.price, 0),
                categories: {
                    ai: active.filter(s => s.category === 'ai').reduce((sum, s) => sum + s.price, 0),
                    creative: active.filter(s => s.category === 'creative').reduce((sum, s) => sum + s.price, 0),
                    productivity: active.filter(s => s.category === 'productivity').reduce((sum, s) => sum + s.price, 0),
                    google: active.filter(s => s.category === 'google').reduce((sum, s) => sum + s.price, 0),
                    other: active.filter(s => s.category === 'other').reduce((sum, s) => sum + s.price, 0),
                }
            };
        }

        function renderStats() {
            const stats = getStats();
            const remaining = budget - stats.monthlyTotal;
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <h3>Monthly</h3>
                    <div class="value">$${stats.monthlyTotal.toFixed(0)}</div>
                    <div class="change">${stats.activeCount} active</div>
                </div>
                <div class="stat-card">
                    <h3>Annual</h3>
                    <div class="value">$${stats.annualTotal.toFixed(0)}</div>
                    <div class="change">projected</div>
                </div>
                <div class="stat-card">
                    <h3>Remaining</h3>
                    <div class="value" style="color: ${remaining >= 0 ? '#64ffda' : '#e94560'}">$${remaining.toFixed(0)}</div>
                    <div class="change">${remaining >= 0 ? 'under budget' : 'over!'}</div>
                </div>
                <div class="stat-card savings">
                    <h3>Saved</h3>
                    <div class="value">$${stats.cancelledTotal.toFixed(0)}</div>
                    <div class="change">cancelled</div>
                </div>
            `;
            
            const pct = Math.min((stats.monthlyTotal / budget) * 100, 100);
            const bar = document.getElementById('budgetProgress');
            bar.style.width = pct + '%';
            bar.className = 'progress-bar' + (stats.monthlyTotal > budget ? ' over-budget' : '');
            document.getElementById('budgetText').textContent = `$${stats.monthlyTotal.toFixed(0)} / $${budget}`;
            document.getElementById('budgetGoal').textContent = `$${budget}`;
        }

        function renderToCancel() {
            const toCancel = subscriptions.filter(s => s.status === 'to-cancel');
            const section = document.getElementById('toCancelSection');
            if (toCancel.length === 0) { section.style.display = 'none'; return; }
            section.style.display = 'block';
            const total = toCancel.reduce((sum, s) => sum + s.price, 0);
            document.getElementById('toCancelList').innerHTML = toCancel.map(s => `
                <div class="to-cancel-item"><span>${s.icon}</span><span>${s.name}</span><span class="price">$${s.price.toFixed(0)}</span></div>
            `).join('');
            document.getElementById('potentialSavings').textContent = `$${total.toFixed(0)}`;
            document.getElementById('potentialAnnualSavings').textContent = `$${(total * 12).toFixed(0)}`;
        }

        function getDaysUntil(day) {
            if (!day) return null;
            const today = new Date().getDate();
            const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
            return day >= today ? day - today : daysInMonth - today + day;
        }

        function renderSubscriptions() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            let filtered = subscriptions.filter(s => {
                if (currentFilter !== 'all' && s.category !== currentFilter) return false;
                if (search && !s.name.toLowerCase().includes(search)) return false;
                return true;
            });
            
            filtered.sort((a, b) => {
                switch (currentSort) {
                    case 'price-high': return b.price - a.price;
                    case 'price-low': return a.price - b.price;
                    case 'billing': return (a.billingDay || 32) - (b.billingDay || 32);
                    case 'rating': return (b.rating || 0) - (a.rating || 0);
                    default: return a.name.localeCompare(b.name);
                }
            });
            
            const list = document.getElementById('subscriptionList');
            if (filtered.length === 0) {
                list.innerHTML = `<div class="empty-state"><div class="icon">üì≠</div><p>No subscriptions found</p></div>`;
                return;
            }
            
            list.innerHTML = filtered.map(sub => {
                const days = getDaysUntil(sub.billingDay);
                const dueText = days !== null ? `Due in ${days}d` : '';
                const dueClass = days !== null && days <= 3 ? 'due-soon' : '';
                const statusClass = sub.status === 'to-cancel' ? 'to-cancel' : '';
                
                return `
                    <div class="subscription-item ${statusClass}">
                        <div class="sub-main">
                            <div class="sub-icon category-${sub.category}">${sub.icon || 'üì¶'}</div>
                            <div class="sub-info">
                                <h4>${sub.name}</h4>
                                <span>${sub.note || ''} ${dueText ? `<span class="${dueClass}">${dueText}</span>` : ''}</span>
                            </div>
                            <div class="sub-price">
                                <div class="amount">$${sub.price.toFixed(0)}</div>
                                <div class="period">/mo</div>
                            </div>
                        </div>
                        <div class="sub-bottom">
                            <div class="rating">
                                ${[1,2,3,4,5].map(i => `<span class="${i <= (sub.rating||0) ? 'active' : ''}" onclick="setRating(${sub.id},${i})">‚≠ê</span>`).join('')}
                            </div>
                            <div class="sub-actions">
                                <button class="btn-edit" onclick="editSub(${sub.id})">‚úèÔ∏è</button>
                                ${sub.status === 'active' 
                                    ? `<button class="btn-cancel" onclick="markCancel(${sub.id})">‚ö†Ô∏è</button>`
                                    : `<button class="btn-restore" onclick="restore(${sub.id})">‚úÖ</button>`}
                                <button class="btn-delete" onclick="deleteSub(${sub.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderCharts() {
            const stats = getStats();
            if (categoryChart) categoryChart.destroy();
            if (trendChart) trendChart.destroy();
            
            categoryChart = new Chart(document.getElementById('categoryChart'), {
                type: 'doughnut',
                data: {
                    labels: ['AI', 'Creative', 'Productivity', 'Google', 'Other'],
                    datasets: [{
                        data: [stats.categories.ai, stats.categories.creative, stats.categories.productivity, stats.categories.google, stats.categories.other],
                        backgroundColor: ['rgba(102,126,234,0.8)', 'rgba(240,147,251,0.8)', 'rgba(79,172,254,0.8)', 'rgba(67,233,123,0.8)', 'rgba(250,112,154,0.8)'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: '#8892b0', padding: 10, font: { size: 10 } } } } }
            });

            const base = stats.monthlyTotal;
            trendChart = new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: {
                    labels: ['Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb'],
                    datasets: [{
                        data: [base*0.92, base*0.95, base*1.02, base*0.98, base*1.01, base],
                        borderColor: '#e94560',
                        backgroundColor: 'rgba(233,69,96,0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { color: '#8892b0', font: { size: 10 } } } } }
            });
        }

        // Modals
        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Add Subscription';
            document.getElementById('subscriptionForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('modalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function editSub(id) {
            const sub = subscriptions.find(s => s.id === id);
            if (!sub) return;
            document.getElementById('modalTitle').textContent = 'Edit';
            document.getElementById('editId').value = id;
            document.getElementById('subName').value = sub.name;
            document.getElementById('subPrice').value = sub.price;
            document.getElementById('subCategory').value = sub.category;
            document.getElementById('subBillingDay').value = sub.billingDay || '';
            document.getElementById('subIcon').value = sub.icon || '';
            document.getElementById('subNote').value = sub.note || '';
            document.getElementById('modalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        function editBudget() {
            document.getElementById('budgetInput').value = budget;
            document.getElementById('budgetModalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeBudgetModal() {
            document.getElementById('budgetModalOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        function openSortModal() {
            document.getElementById('sortModal').classList.add('active');
            document.getElementById('sortOverlay').classList.add('active');
            document.querySelectorAll('.sort-option').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.sort === currentSort);
            });
        }

        function closeSortModal() {
            document.getElementById('sortModal').classList.remove('active');
            document.getElementById('sortOverlay').classList.remove('active');
        }

        // Form handlers
        document.getElementById('subscriptionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const editId = document.getElementById('editId').value;
            const newSub = {
                id: editId ? parseInt(editId) : Date.now(),
                name: document.getElementById('subName').value,
                price: parseFloat(document.getElementById('subPrice').value),
                category: document.getElementById('subCategory').value,
                billingDay: parseInt(document.getElementById('subBillingDay').value) || null,
                icon: document.getElementById('subIcon').value || 'üì¶',
                note: document.getElementById('subNote').value,
                rating: 0,
                status: 'active'
            };
            
            if (editId) {
                const idx = subscriptions.findIndex(s => s.id === parseInt(editId));
                if (idx !== -1) { newSub.rating = subscriptions[idx].rating; newSub.status = subscriptions[idx].status; subscriptions[idx] = newSub; }
                showToast('Updated!');
            } else {
                subscriptions.push(newSub);
                showToast('Added!');
            }
            saveData(); renderAll(); closeModal();
        });

        document.getElementById('budgetForm').addEventListener('submit', function(e) {
            e.preventDefault();
            budget = parseFloat(document.getElementById('budgetInput').value);
            saveData(); renderAll(); closeBudgetModal();
            showToast('Budget saved!');
        });

        // Sort options
        document.querySelectorAll('.sort-option').forEach(opt => {
            opt.addEventListener('click', () => {
                currentSort = opt.dataset.sort;
                renderSubscriptions();
                closeSortModal();
            });
        });

        // Actions
        function setRating(id, r) {
            const sub = subscriptions.find(s => s.id === id);
            if (sub) { sub.rating = r; saveData(); renderSubscriptions(); }
        }

        function markCancel(id) {
            const sub = subscriptions.find(s => s.id === id);
            if (sub) { sub.status = 'to-cancel'; saveData(); renderAll(); showToast('Marked to cancel'); }
        }

        function restore(id) {
            const sub = subscriptions.find(s => s.id === id);
            if (sub) { sub.status = 'active'; saveData(); renderAll(); showToast('Restored!'); }
        }

        function deleteSub(id) {
            if (confirm('Delete?')) {
                subscriptions = subscriptions.filter(s => s.id !== id);
                saveData(); renderAll(); showToast('Deleted');
            }
        }

        function exportCSV() {
            const rows = [['Name','Category','Price','Billing Day','Rating','Status','Note']];
            subscriptions.forEach(s => rows.push([s.name, s.category, s.price, s.billingDay||'', s.rating||0, s.status, s.note||'']));
            const csv = rows.map(r => r.join(',')).join('\n');
            const a = document.createElement('a');
            a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
            a.download = 'subscriptions.csv';
            a.click();
            showToast('Exported!');
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // Filter tabs
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentFilter = tab.dataset.filter;
                renderSubscriptions();
            });
        });

        document.getElementById('searchInput').addEventListener('input', renderSubscriptions);

        function renderAll() {
            renderStats();
            renderToCancel();
            renderSubscriptions();
            renderCharts();
        }

        loadData();
        renderAll();
    </script>
</body>
</html>
